# Terraformã¨LocalStackã‚’ç”¨ã„ãŸAWSç’°å¢ƒï¼ˆS3, Lambda, Amplifyï¼‰ã®IaCãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
Terraformã¨LocalStackã‚’ä½¿ç”¨ã—ã¦awsã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã—è‡ªå‹•ä½œæˆ

## æ¦‚è¦
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**Infrastructure as Code (IaC)** ã®åŸå‰‡ã«åŸºã¥ãã€**Terraform** ã¨ **LocalStack** ã‚’æ´»ç”¨ã—ã¦AWSç’°å¢ƒã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚ç‰¹ã«ã€S3ãƒã‚±ãƒƒãƒˆã€Lambdaé–¢æ•°ã€Amplifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã„ã£ãŸä¸»è¦ãªAWSãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºãƒ»æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã®åŠ¹ç‡åŒ–ã¨ä¸€è²«æ€§ã®ç¢ºä¿ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

LocalStackã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§AWSã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å®‰å…¨ã‹ã¤è¿…é€Ÿãªãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## ä½¿ç”¨æŠ€è¡“
- Terraform
- Terraform Cloud
- AWSå„ã‚µãƒ¼ãƒ“ã‚¹ / AWS CLI
- LocalStack
- Docker
- github / github CLI

## æº–å‚™
- github access token
- awsã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆOIDCï¼‰
- Lambdaé–¢æ•°ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰æˆæœç‰©
- Amplifyç”¨ã®GitHubãƒªãƒã‚¸ãƒˆãƒª
- terraform cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆdev, prodï¼‰
- cloudã§ã®å¤‰æ•°è¨­å®š
- SSMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- CORSç”¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã®æ›´æ–°
- ECRç”¨ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸
- sslãŒå¿…è¦ãªå ´åˆã¯sslè¨¼æ˜æ›¸

## æ§‹æˆ
```text
/
â”œâ”€â”€ .devcontainer/
â”‚   â”œâ”€â”€ devcontainer.json
â”‚   â””â”€â”€ setup.sh
â”œâ”€â”€ bootstrap/
â”‚   â”œâ”€â”€ main.tf   # OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ»èªè¨¼ã€IAMãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒªã‚·ãƒ¼è¨­å®š
â”‚   â”œâ”€â”€ variables.tf
â”‚   â””â”€â”€ outputs.tf
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ environments/ # ç’°å¢ƒã”ã¨ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
â”‚   â”‚   â”œâ”€â”€ local/      
â”‚   â”‚   â”‚   â”œâ”€â”€ provider.tf      
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—(terraform/main.tf)
â”‚   â”‚   â”‚   â””â”€â”€ variables.tf  
â”‚   â”‚   â”œâ”€â”€ dev/      
â”‚   â”‚   â”‚   â”œâ”€â”€ provider.tf      
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”‚   â””â”€â”€ variables.tf  
â”‚   â”‚   â””â”€â”€ prod/      
â”‚   â”‚       â”œâ”€â”€ provider.tf      
â”‚   â”‚       â”œâ”€â”€ main.tf
â”‚   â”‚       â””â”€â”€ variables.tf  
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ s3/                 # S3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # S3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹å®šç¾© (s3ãƒã‚±ãƒƒãƒˆãªã©)
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf    # S3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å›ºæœ‰ã®å¤‰æ•°å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ outputs.tf      # S3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å›ºæœ‰ã®å‡ºåŠ›å®šç¾©
â”‚   â”‚   â”‚   â””â”€â”€ bucket_policy.tf  
â”‚   â”‚   â”œâ”€â”€ cloudfront/         # cloudfrontãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãªã©ã®å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf    
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf      
â”‚   â”‚   â”œâ”€â”€ lambda/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # Lambdaé–¢æ•°ã€IAMãƒ­ãƒ¼ãƒ«ã€ãƒãƒªã‚·ãƒ¼
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ s3-lambda-integration/ # S3ã¨Lambdaã®é€£æºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # S3é€šçŸ¥è¨­å®šã€Lambdaæ¨©é™
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ amplify/            # Amplifyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # Amplifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ–ãƒ©ãƒ³ãƒãªã©ã®å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ ecr/                # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒªãƒã‚¸ãƒˆãƒª
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # ECRãƒªãƒã‚¸ãƒˆãƒªã¨ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼ãªã©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ ecs-cluster/        # ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å®šç¾© (EC2/Fargate ä¸¡å¯¾å¿œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€CloudWatchãƒ­ã‚°è¨­å®šãªã©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ ecs-service-fargate/  # Fargateã‚µãƒ¼ãƒ“ã‚¹å°‚ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # Fargateã‚¿ã‚¹ã‚¯å®šç¾©ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ALBã‚¿ãƒ¼ã‚²ãƒƒãƒˆç™»éŒ²ç­‰
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ network/            # VPCãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ä¸€å¼ï¼ˆã‚µãƒ–ãƒãƒƒãƒˆ, SGç­‰å«ã‚€ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # VPC, IGW, Subnet, Route Table, Security Groupãªã©ã®æ§‹æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â”œâ”€â”€ security_group.tf # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ«ãƒ¼ãƒ«ã®ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ rds/                # RDSãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ aurora/             # Auroraãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf         # Auroraã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ alb/                # ALBãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚       â”œâ”€â”€ main.tf         # ALBæœ¬ä½“ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã€HTTP/HTTPSãƒªã‚¹ãƒŠãƒ¼ã€ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«å®šç¾©
â”‚   â”‚       â”œâ”€â”€ variables.tf
â”‚   â”‚       â””â”€â”€ outputs.tf
â”‚   â”œâ”€â”€ main.tf                 # ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®main.tf (modules/ ã‚’å‘¼ã³å‡ºã™)
â”‚   â”œâ”€â”€ variables.tf            # ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¤‰æ•°å®šç¾©
â”‚   â”œâ”€â”€ outputs.tf              # ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡ºåŠ›å®šç¾©
â”‚   â”œâ”€â”€ locals.tf               # å…±é€šãƒ»åŸºæœ¬è¨­å®š
â”‚   â”œâ”€â”€ locals-storage.tf       # S3ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é–¢é€£
â”‚   â”œâ”€â”€ locals-database.tf      # RDSãƒ»Auroraé–¢é€£
â”‚   â””â”€â”€ locals-compute.tf       # ECSãƒ»Lambdaãƒ»ALBé–¢é€£
â”œâ”€â”€ README.md
â”œâ”€â”€ Makefile
â””â”€â”€ .gitignore

```

## ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†é›¢æ§‹æˆ
```text

terraform/
â”œâ”€â”€ segments/
â”‚   â”œâ”€â”€ foundation/              # åŸºç›¤ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ environments/
â”‚   â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ provider.tf
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf      # ../..ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚   â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”‚   â””â”€â”€ prod/
â”‚   â”‚   â”œâ”€â”€ main.tf              # åŸºç›¤ãƒªã‚½ãƒ¼ã‚¹ã®ã¿
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf           # ä»–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‘ã‘ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ
â”‚   â”‚   â”œâ”€â”€ locals-network.tf    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
â”‚   â”‚   â””â”€â”€ locals-database.tf   # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
â”‚   â”œâ”€â”€ application/             # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ  
â”‚   â”‚   â”œâ”€â”€ environments/
â”‚   â”‚   â”œâ”€â”€ main.tf              # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ remote_state.tf      # foundationã‹ã‚‰ã®å–å¾—
â”‚   â”‚   â”œâ”€â”€ locals-storage.tf    # S3, CloudFrontè¨­å®š
â”‚   â”‚   â””â”€â”€ locals-compute.tf    # ECS, ALBè¨­å®š
â”‚   â””â”€â”€ data-processing/         # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ environments/
â”‚       â”œâ”€â”€ main.tf              # Lambda, S3çµ±åˆãªã©
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ outputs.tf
â”‚       â””â”€â”€ remote_state.tf      # foundationã‹ã‚‰ã®å–å¾—
â””â”€â”€ modules/                     # æ—¢å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
```

## è¨­è¨ˆã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¸€å…ƒç®¡ç†ã¨ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ã®å‰Šæ¸›
æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å„ç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç›´æ¥å‘¼ã³å‡ºã™ä»£ã‚ã‚Šã«ã€å…±é€šã®ãƒ«ãƒ¼ãƒˆTerraformæ§‹æˆ (terraform/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª) ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦å‘¼ã³å‡ºã—ã€ãã®ä¸­ã§ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆã‚’åˆ¶å¾¡ã™ã‚‹è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ä»¥ä¸‹ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«é¸æŠã•ã‚Œã¾ã—ãŸã€‚

**ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆã®å¢—å¤§**:   
ã‚‚ã—å„ç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆenvironments/localã€environments/devã€environments/prodï¼‰ã®main.tfã§å€‹åˆ¥ã«S3ãƒã‚±ãƒƒãƒˆã‚„Lambdaé–¢æ•°ãªã©ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™å ´åˆã€å¤šãã®ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚ã‚‹å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¥åŠ›å¤‰æ•°ã‚’è¿½åŠ ã—ãŸã‚Šã€ãã®è¨­å®šã‚’å¤‰æ›´ã—ãŸã‚Šã™ã‚‹ãŸã³ã«ã€ã™ã¹ã¦ã®ç’°å¢ƒã®main.tfã‚’æ‰‹å‹•ã§ä¿®æ­£ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ã¾ã™ã€‚ã“ã‚Œã¯å¤§è¦æ¨¡ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚‹ã»ã©ã€éå¸¸ã«æ‰‹é–“ãŒã‹ã‹ã‚Šã€éåŠ¹ç‡çš„ã§ã™ã€‚

**ç’°å¢ƒé–“ã®ä¸€è²«æ€§æ¬ å¦‚ã¨ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯**:   
æ‰‹å‹•ã§ã®è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ã¯ã€ç’°å¢ƒé–“ã§ã®è¨­å®šã®ä¸ä¸€è‡´ã‚’å¼•ãèµ·ã“ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ç‰¹å®šã®ç’°å¢ƒã§ä¿®æ­£ãŒæ¼ã‚ŒãŸã‚Šã€èª¤ã£ãŸè¨­å®šã‚’ã—ã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã€ã‚¤ãƒ³ãƒ•ãƒ©ã®ä¿¡é ¼æ€§ã‚’æãªã†åŸå› ã¨ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ã€å…±é€šã®å¤‰æ›´ãŒã™ã¹ã¦ã®ç’°å¢ƒã§æ­£ã—ãé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ä½œæ¥­ãŒè¤‡é›‘åŒ–ã—ã¾ã™ã€‚

### ç¾åœ¨ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆ:

**ã‚³ãƒ¼ãƒ‰ã®ä¸€å…ƒåŒ–**:   
ã»ã¨ã‚“ã©ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‘¼ã³å‡ºã—ã¨è¨­å®šãŒãƒ«ãƒ¼ãƒˆã®terraform/main.tfã«é›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å…±é€šã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã‚’å¤‰æ›´ã™ã‚‹éš›ã®ä¿®æ­£ç®‡æ‰€ãŒæœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã€å˜ä¸€ã®å ´æ‰€ã§å…¨ä½“åƒã‚’æŠŠæ¡ã—ã€ç®¡ç†ã§ãã¾ã™ã€‚

**ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ã®å‰Šæ¸›**:   
å…±é€šéƒ¨åˆ†ã®å¤‰æ›´ã¯ä¸€ç®‡æ‰€ã«é›†ä¸­ã™ã‚‹ãŸã‚ã€ç’°å¢ƒé–“ã§ã®è¨­å®šã®ä¸ä¸€è‡´ã‚„ä¿®æ­£æ¼ã‚Œã¨ã„ã£ãŸãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯ãŒå¤§å¹…ã«ä½æ¸›ã•ã‚Œã¾ã™ã€‚

### ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨è€ƒæ…®äº‹é …:

ã“ã®è¨­è¨ˆã«ã¯ã€ãƒ«ãƒ¼ãƒˆmain.tfãŒvar.environmentã«åŸºã¥ãcountã®æ¡ä»¶åˆ†å²ã§è¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã„ã†ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®ã€Œä¸€ç®‡æ‰€ã«é›†ç´„ã•ã‚ŒãŸè¤‡é›‘ã•ã€ã¯ã€å„ç’°å¢ƒã«ã‚³ãƒ¼ãƒ‰ãŒæ•£ã‚‰ã°ã‚‹ã“ã¨ã«ã‚ˆã‚‹ã€Œåˆ†æ•£ã—ãŸè¤‡é›‘ã•ã€ã‚ˆã‚Šã‚‚ã€ãƒ‡ãƒãƒƒã‚°ã‚„å…¨ä½“åƒã®æŠŠæ¡ãŒã—ã‚„ã™ã„ã¨åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚try()é–¢æ•°ãªã©ã®Terraformã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€æ¡ä»¶ä»˜ãã®ãƒªã‚½ãƒ¼ã‚¹å‚ç…§ã‚‚å®‰å…¨ã«è¡Œã£ã¦ã„ã¾ã™ã€‚

### ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®æµã‚Œ

ãƒªã‚½ãƒ¼ã‚¹ãŒã©ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚Œã‚‹ã‹ã®å…¨ä½“åƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
flowchart LR
    A["é–‹ç™ºè€…"] --> B{"make local-xxxã‚’å®Ÿè¡Œ"}
    B --> C["terraform/environments/localãŒå®Ÿè¡Œã•ã‚Œã‚‹"]
    C --> D["terraform/main.tfãŒå‘¼ã³å‡ºã•ã‚Œã‚‹"]
    D --> E["locals-*.tfã‚’èª­ã¿è¾¼ã¿"]
    E --> F["å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¨­å®šå€¤ã‚’æ¸¡ã™"]
    F --> G["å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã‚‹"]
    G --> H["ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ (LocalStack/AWS)"]
    H --> I["å®Œäº†"]
```

### ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦å›³
```mermaid
graph TB
    subgraph "ğŸ” ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦ - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹"
        Users[ğŸ‘¥ Users] --> CloudFront[CloudFront<br/>CDN]
        CloudFront --> Frontend[React App<br/>S3 Static Website]
        Users --> API[REST API<br/>via ALB]
        API --> Backend[Backend Service<br/>ECS Fargate]
        Backend --> Database[(Database<br/>RDS/Aurora)]
        
        Users --> Upload[File Upload]
        Upload --> Processing[Auto Processing<br/>Lambda]
    end
```

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå›³
```mermaid
graph TB
    subgraph "ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ"
        subgraph VPC["VPC (10.0.0.0/16)"]
            subgraph PublicZone["ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¾ãƒ¼ãƒ³"]
                PubSub1[Public Subnet 1<br/>10.0.1.0/24<br/>AZ-a]
                PubSub2[Public Subnet 2<br/>10.0.2.0/24<br/>AZ-b]
                ALB[Application<br/>Load Balancer]
                Fargate[ECS Fargate<br/>Tasks]
            end
            
            subgraph PrivateZone["ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³"]
                PrivSub1[Private Subnet 1<br/>10.0.11.0/24<br/>AZ-a]
                PrivSub2[Private Subnet 2<br/>10.0.12.0/24<br/>AZ-b]
                RDS[(RDS Instance)]
                Aurora[(Aurora Cluster)]
            end
        end
        
        Internet[ğŸŒ Internet] --> CloudFront[CloudFront<br/>CDN]
        CloudFront --> S3[S3 Static Website]
        Internet --> IGW[Internet Gateway]
        IGW --> PubSub1
        IGW --> PubSub2
        
        Internet -->|HTTP/HTTPS<br/>Port 80/443| ALB
        ALB -->|Port 8080| Fargate
        
        PubSub1 --> ALB
        PubSub2 --> ALB
        PubSub1 --> Fargate
        PubSub2 --> Fargate
        
        PrivSub1 --> RDS
        PrivSub2 --> Aurora
        
        Fargate -->|PostgreSQL<br/>Port 5432| RDS
        Fargate -->|MySQL<br/>Port 3306| Aurora
        Fargate -->|HTTPS/HTTP<br/>Port 443/80| Internet
    end
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆå›³
```mermaid

graph TB
    subgraph "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆ"
        subgraph Internet["ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"]
            Users[ğŸ‘¥ Users<br/>0.0.0.0/0]
        end
        
        subgraph ALBSG["ğŸ›¡ï¸ ALB Security Group"]
            ALB[Application<br/>Load Balancer]
        end
        
        subgraph AppSG["ğŸ›¡ï¸ Application Security Group"]
            Fargate[ECS Fargate<br/>Backend Service]
        end
        
        subgraph DBSG["ğŸ›¡ï¸ Database Security Group"]
            RDS[(RDS<br/>PostgreSQL)]
            Aurora[(Aurora<br/>MySQL)]
        end
        
        subgraph VPCESG["ğŸ›¡ï¸ VPC Endpoint Security Group"]
            VPCE[VPC Endpoints<br/>S3, ECR, etc.]
        end
        
        subgraph External["ğŸŒ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹"]
            S3[S3 APIs]
            APIs[External APIs]
        end
        
        %% ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«
        Users -->|HTTP: 80<br/>HTTPS: 443| ALB
        ALB -->|App Port: 8080| Fargate
        Fargate -->|PostgreSQL: 5432| RDS
        Fargate -->|MySQL: 3306| Aurora
        Fargate -->|HTTPS: 443| VPCE
        
        %% ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼‰
        Fargate -->|HTTPS: 443<br/>HTTP: 80| S3
        Fargate -->|HTTPS: 443<br/>HTTP: 80| APIs
        
        %% æ¡ä»¶ä»˜ããƒ«ãƒ¼ãƒ«ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
        subgraph DevOnly["ğŸ”§ é–‹ç™ºç’°å¢ƒã®ã¿"]
            DevSSH[Developer<br/>SSH Access]
        end
        DevSSH -.->|SSH: 22<br/>ç‰¹å®šCIDR| Fargate
    end
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef sgBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef internet fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef dev fill:#fff3e0,stroke:#f57c00,stroke-width:1px,stroke-dasharray: 5 5
    
    class ALBSG,AppSG,DBSG,VPCESG sgBox
    class Internet,External internet
    class RDS,Aurora database
    class DevOnly,DevSSH dev
```

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**S3ãƒã‚±ãƒƒãƒˆ (modules/s3)**
- **ç›®çš„**: é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¿å­˜
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°S3ãƒã‚±ãƒƒãƒˆï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã€ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆè¨­å®šï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¿å­˜ç”¨ã®è¤‡æ•°ãƒã‚±ãƒƒãƒˆï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã€æ–‡æ›¸ã€ä¸€æ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æš—å·åŒ–ï¼ˆSSE-S3ï¼‰ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã®è¨­å®š
  - CORSè¨­å®šã¨ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**Lambdaé–¢æ•° (modules/lambda)**
- **ç›®çš„**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹å‡¦ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒªãƒ–ãƒ³å‹ã®å‡¦ç†å®Ÿè¡Œ
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - Lambdaé–¢æ•°æœ¬ä½“ï¼ˆZIPå½¢å¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰
  - å®Ÿè¡Œç”¨IAMãƒ­ãƒ¼ãƒ«ï¼ˆLambda Basic Execution Roleï¼‰
  - S3ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ IAMãƒãƒªã‚·ãƒ¼
  - CloudWatch Logsã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ­ã‚°ä¿æŒæœŸé–“è¨­å®š
  - ç’°å¢ƒå¤‰æ•°ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

**S3-Lambdaçµ±åˆ (modules/s3-lambda-integration)**
- **ç›®çš„**: S3ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹Lambdaé–¢æ•°ã®è‡ªå‹•å®Ÿè¡Œ
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - S3ãƒã‚±ãƒƒãƒˆé€šçŸ¥è¨­å®šï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  - Lambdaé–¢æ•°å®Ÿè¡Œæ¨©é™ï¼ˆS3ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®å‘¼ã³å‡ºã—è¨±å¯ï¼‰
  - ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰

**Amplifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (modules/amplify)**
- **ç›®çš„**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - Amplifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆGitHubãƒªãƒã‚¸ãƒˆãƒªé€£æºï¼‰
  - ãƒ–ãƒ©ãƒ³ãƒè¨­å®šï¼ˆmain/developãƒ–ãƒ©ãƒ³ãƒï¼‰
  - è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
  - ç’°å¢ƒå¤‰æ•°ã¨ãƒ“ãƒ«ãƒ‰è¨­å®š
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ã‚³ãƒ³ãƒ†ãƒŠãƒ»ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**ECR (modules/ecr)**
- **ç›®çš„**: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜ã¨ç®¡ç†
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - ECRãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª
  - ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼ï¼ˆå¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è‡ªå‹•å‰Šé™¤ï¼‰
  - ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š
  - ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œï¼‰

**ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ (modules/ecs-cluster)**
- **ç›®çš„**: ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºç›¤æä¾›
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ï¼ˆEC2/Fargateä¸¡å¯¾å¿œï¼‰
  - CloudWatchãƒ­ã‚°è¨­å®š
  - ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
  - ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¨­å®šï¼ˆã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚µã‚¤ãƒˆæœ‰åŠ¹åŒ–ï¼‰

**ECS Fargateã‚µãƒ¼ãƒ“ã‚¹ (modules/ecs-service-fargate)**
- **ç›®çš„**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®å®Ÿè¡Œã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - Fargateã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆCPUã€ãƒ¡ãƒ¢ãƒªã€ã‚³ãƒ³ãƒ†ãƒŠè¨­å®šï¼‰
  - ECSã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ‡ã‚¶ã‚¤ã‚¢ãƒ‰ã‚«ã‚¦ãƒ³ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼‰
  - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œç”¨IAMãƒ­ãƒ¼ãƒ«
  - ALBã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ç™»éŒ²
  - Auto Scalingãƒãƒªã‚·ãƒ¼ï¼ˆCPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ï¼‰
  - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ (modules/network)**
- **ç›®çš„**: ã‚»ã‚­ãƒ¥ã‚¢ã§é«˜å¯ç”¨æ€§ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ã®æ§‹ç¯‰
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - VPCï¼ˆVirtual Private Cloudï¼‰
  - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆIGWï¼‰
  - ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆï¼ˆãƒãƒ«ãƒAZæ§‹æˆï¼‰
  - ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¨é–¢é€£ä»˜ã‘
  - NATã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆç”¨ï¼‰
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆWebã€Appã€DBå±¤åˆ¥ï¼‰
  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ACLè¨­å®š

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**RDS (modules/rds)**
- **ç›®çš„**: ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†ã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆMySQLã€PostgreSQLå¯¾å¿œï¼‰
  - DBã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆé…ç½®ï¼‰
  - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–è¨­å®šï¼‰
  - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
  - è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šï¼ˆãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ ãƒªã‚«ãƒãƒªï¼‰
  - æš—å·åŒ–è¨­å®šï¼ˆKMSï¼‰
  - ãƒãƒ«ãƒAZé…ç½®ï¼ˆé«˜å¯ç”¨æ€§ï¼‰
  - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š

**Aurora (modules/aurora)**
- **ç›®çš„**: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ãªé«˜æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - Auroraã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ï¼ˆMySQL/PostgreSQLäº’æ›ï¼‰
  - Auroraã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆãƒ©ã‚¤ã‚¿ãƒ¼ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼ï¼‰
  - ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—
  - è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š
  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè¨­å®š
  - é«˜å¯ç”¨æ€§è¨­å®šï¼ˆãƒãƒ«ãƒAZï¼‰
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®šï¼ˆèª­ã¿æ›¸ãåˆ†é›¢ï¼‰

### ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**ALB (modules/alb)**
- **ç›®çš„**: é«˜å¯ç”¨æ€§ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è² è·åˆ†æ•£
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - Application Load Balanceræœ¬ä½“
  - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ»IPãƒ»Lambdaå¯¾å¿œï¼‰
  - HTTPSãƒªã‚¹ãƒŠãƒ¼ï¼ˆSSL/TLSçµ‚ç«¯ï¼‰
  - HTTPãƒªã‚¹ãƒŠãƒ¼ï¼ˆHTTPSè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
  - ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«
  - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
  - SSLè¨¼æ˜æ›¸è¨­å®šï¼ˆACMé€£æºï¼‰
  - WAFçµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨­å®š

### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**CloudFront (modules/cloudfront)**
- **ç›®çš„**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ã‚’é«˜é€ŸåŒ–ãƒ»æœ€é©åŒ–ã—ã€S3ã‚„ALBãªã©ã®ã‚ªãƒªã‚¸ãƒ³ã¸ã®è² è·ã‚’è»½æ¸›
- **ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹**:
  - CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ (S3ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒªã‚¸ãƒ³å¯¾å¿œ)
  - Origin Access Control (OAC) è¨­å®šï¼ˆS3ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ï¼‰
  - ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒªã‚·ãƒ¼ï¼ˆHTTPSã¸ã®å¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŠã‚ˆã³è¿½åŠ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢
  - TTLï¼ˆTime-to-Liveï¼‰è¨­å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ï¼‰
  - SPAï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰å¯¾å¿œã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ403/404ã‚¨ãƒ©ãƒ¼ã‚’index.htmlã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
  - SSLè¨¼æ˜æ›¸è¨­å®šï¼ˆACMé€£æºã¾ãŸã¯CloudFrontãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  - WAFçµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨­å®š

## OIDCèªè¨¼ç”¨ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯terraformç”¨ãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒªãƒã‚¸ãƒˆãƒªã¯åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ã®CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§awsã¸èªè¨¼ã—ã€ECRã«dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pushã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ãã®ç‚ºã€terraformã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã™ã‚‹å ´åˆã€ã¾ãšawså´ã«OIDCèªè¨¼ã®IAMãƒ­ãƒ¼ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
bootstrap/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```terraform
data "tls_certificate" "github_actions_deploy" {
  url = "https://token.actions.githubusercontent.com/.well-known/openid-configuration"
  #url = "https://token.actions.githubusercontent.com"
}

resource "aws_iam_openid_connect_provider" "github_actions_deploy" {
  url             = "https://token.actions.githubusercontent.com"
  client_id_list  = ["sts.amazonaws.com"]
  thumbprint_list = [data.tls_certificate.github_actions_deploy.certificates[0].sha1_fingerprint]
}
```

### GitHub Actions ç”¨ OIDC èªè¨¼ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ

Terraform ã§OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’AWSã«ç™»éŒ²ã—ãŸå¾Œã€GitHub Actionsã‹ã‚‰AWSã«èªè¨¼ã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ç‰¹å®šã®ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿AssumeRoleã‚’è¨±å¯ã—ã€ECRã¸Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Pushã™ã‚‹ãŸã‚ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¦ã„ã¾ã™ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ãƒ–ãƒ©ãƒ³ãƒæ¡ä»¶ã¯å¿…ãšè¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

```terraform
// GitHub Actionsç”¨ IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
resource "aws_iam_role" "github_actions_deploy_role" {
  name = "github-actions-deploy-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Effect = "Allow",
        Principal = {
          Federated = aws_iam_openid_connect_provider.github_actions_deploy.arn
        },
        Action = "sts:AssumeRoleWithWebIdentity",
        Condition = {
          StringEquals = {
            # GitHub Actions ã®ãƒªãƒã‚¸ãƒˆãƒªã¨ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ¶é™
            "token.actions.githubusercontent.com:sub" = "repo:your-org/your-repo:ref:refs/heads/main"
          }
        }
      }
    ]
  })
}

// å¿…è¦ãªãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒï¼ˆECR Pushç”¨ï¼‰
resource "aws_iam_role_policy" "github_actions_ecr_policy" {
  name = "github-actions-ecr-policy"
  role = aws_iam_role.github_actions_deploy_role.id

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Effect   = "Allow",
        Action   = [
          "ecr:GetAuthorizationToken",
          "ecr:BatchCheckLayerAvailability",
          "ecr:CompleteLayerUpload",
          "ecr:InitiateLayerUpload",
          "ecr:PutImage",
          "ecr:UploadLayerPart"
        ],
        Resource = "*"
      }
    ]
  })
}

```

## ç’°å¢ƒã”ã¨ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã¨ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®åˆ¶å¾¡

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€é–‹ç™ºç’°å¢ƒï¼ˆLocalStackï¼‰ã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã¨ãƒªã‚½ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€**Terraformå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç’°å¢ƒã”ã¨ã«åˆ†é›¢ã™ã‚‹**è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

å„ç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`environments/local`ã€`environments/dev`ã€`environments/prod`ï¼‰ã¯ã€ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ãŸTerraformã®å®Ÿè¡Œãƒã‚¤ãƒ³ãƒˆã¨ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã¯ã€ãã®ç’°å¢ƒå›ºæœ‰ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã¨ã€å…±é€šã®**ãƒ«ãƒ¼ãƒˆTerraformæ§‹æˆ (`../..` ã«ä½ç½®ã™ã‚‹ `terraform/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“)** ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦å‘¼ã³å‡ºã™è¨­å®šãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

**LocalStack ç’°å¢ƒã§ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š:**
- `terraform/environments/local` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§Terraformã‚’å®Ÿè¡Œã—ãŸå ´åˆã€`terraform/environments/local/providers.tf`å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹`endpoints`ãƒ–ãƒ­ãƒƒã‚¯ãŒæœ‰åŠ¹ã«ãªã‚Šã€AWSã®å„ã‚µãƒ¼ãƒ“ã‚¹ã¯`http://localhost:4566` (LocalStack) ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚   

- LocalStackã§S3ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€`s3_use_path_style = true` ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯ã€S3ã®URLã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼š

- **Virtual hosted-style** (AWSæ¨™æº–): `https://bucket-name.s3.amazonaws.com/key`
- **Path-style** (LocalStackç”¨): `https://s3.amazonaws.com/bucket-name/key`

ä¾‹ï¼š
```terraform
endpoints {
    s3_use_path_style = true # LocalStack S3ã®æ¨å¥¨è¨­å®š
    content {
      s3       = "http://localhost:4566"
```

### workspaceã‚’ä½¿ç”¨ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã‚’é™¤å¤–ã™ã‚‹å ´åˆ
Terraformã®**ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ (`terraform workspace`)** æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€é–‹ç™ºç’°å¢ƒ (LocalStack) ã¨æœ¬ç•ªç’°å¢ƒã§åŒã˜Terraformã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚   
terraform workspace new localã§localãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã€LocalStackã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆè‡ªä½“ã‚’åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚

ä¾‹ï¼š
```
count = terraform.workspace == "local" ? 0 : 1
```

**æ³¨æ„**:
terraform workspaceã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå˜ä½ã§è¨­å®šã—ã¾ã™ã€‚   
environmentså†…ã®ç’°å¢ƒã”ã¨ã§åˆ†ã‘ã¦ã„ã‚‹å ´åˆã€ãƒ«ãƒ¼ãƒˆã§ã¯ãªãlocalå†…ã§terraform workspace new localã‚’ã—ãªã‘ã‚Œã°ç’°å¢ƒãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã›ã‚“ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

### workspaceã‚’ä½¿ç”¨ã—ãªã„å ´åˆ
workspaceãªã©ã§åˆ†å²ã—ãªã„å ´åˆã€å€‹åˆ¥ã«environmentå¤‰æ•°ãªã©ã§æ¡ä»¶åˆ†å²ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚   
ãã®éš›ã€è¦ªå´ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºå®šã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```terraform
// ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å¤‰æ•°ã®å€¤è‡ªä½“ãŒçœŸå½å€¤ã§ã‚ã‚‹å ´åˆã€
// ãã®æ¡ä»¶ãŒç¤ºã™ç’°å¢ƒãŒä¸æ˜ç­ã«ãªã‚‹ãŸã‚æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚
// count = var.some_boolean_flag ? 1 : 0

count = var.environment == "local" ? 1 : 0 // ã“ã‚Œã¯OK
```

**æ³¨æ„**
countãƒ¡ã‚¿å¼•æ•°ã‚’ç”¨ã„ã¦ãƒªã‚½ãƒ¼ã‚¹ãŒæ¡ä»¶ä»˜ãã§ä½œæˆã•ã‚Œã‚‹å ´åˆã€Terraformã¯ãã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å¸¸ã«é…åˆ—ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ãŸã¨ãˆ count=1ã§ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã‚‚ã€ãã®å±æ€§ã‚’å‚ç…§ã™ã‚‹éš›ã«ã¯é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ([0]) ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€count=0ã®ãŸã‚ã«ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œãªã„å ´åˆã€[0]ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã®ç›´æ¥å‚ç…§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ã“ã®å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã«ã¯ã€try(aws_resource_type.name[0].attribute, null) ã‚„ length(aws_resource_type.name) > 0 ? aws_resource_type.name[0].attribute : null ã®ã‚ˆã†ãªè©³ç´°ãªæ¡ä»¶åˆ†å²ãŒå¿…è¦ã¨ãªã‚Šã€Terraformã‚³ãƒ¼ãƒ‰å…¨ä½“ãŒè¤‡é›‘åŒ–ã™ã‚‹ãŸã‚ã€ç‰¹ã«ãƒ«ãƒ¼ãƒˆæ§‹æˆã§å¤šæ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨ã•ã‚Œã‚‹å ´åˆã¯ã€è¤‡é›‘ã•ãŒå¢—å¤§ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

# Terraform Remote State è¨­å®šã‚¬ã‚¤ãƒ‰

## LocalStackã§ãƒ­ãƒ¼ã‚«ãƒ«ã«S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§Terraformã®stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€LocalStackã‚’ä½¿ã£ã¦S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
awslocal s3 mb s3://[ãƒã‚±ãƒƒãƒˆå]
```

## remote_stateã§åˆ¥ã®tfstateã®outputã‚’å–å¾—

### è¨­å®šæ–¹æ³•

ä»–ã®Terraformãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®stateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰outputã‚’å‚ç…§ã™ã‚‹ã«ã¯ã€`terraform_remote_state`ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚backendã§æŒ‡å®šã—ãŸS3ãƒã‚±ãƒƒãƒˆåã¨ã‚­ãƒ¼åã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„ã€‚

```terraform
data "terraform_remote_state" "application" {
  backend = "s3"
  config = {
    bucket = "your-terraform-state-bucket"
    key    = "application/terraform.tfstate"
    region = "ap-northeast-1"

    # LocalStackä½¿ç”¨æ™‚ã®è¨­å®š
    endpoints = {
      s3 = "http://localhost:4566"
    }

    access_key = "test"
    secret_key = "test"
    skip_credentials_validation = true
    skip_metadata_api_check = true
    use_path_style = true
    skip_requesting_account_id = true
  }
}
```

### outputã®å–å¾—

ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®outputã‚’å–å¾—ã§ãã¾ã™ã€‚

```terraform
subnets = data.terraform_remote_state.foundation.outputs.public_subnet_ids
```

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª

### ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¸­èº«ã‚’è¦‹ã‚‹

`awslocal s3 cp`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

```bash
awslocal s3 cp s3://your-terraform-state-bucket/[ãƒ‘ã‚¹]/terraform.tfstate .
```

## æ³¨æ„ç‚¹

### outputsã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§è¡Œã†

`terraform apply`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§`outputs`ã‚’è¨­å®šã—ãªã„ã¨ã€stateãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å‚ç…§ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã¯ã€å¿…ãšãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§outputã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚

## object_ownershipã®åˆ†é›¢
aws providerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚ŠAWS Provider v4.9.0ä»¥é™ã¯object_ownershipãŒå˜ç‹¬ãƒªã‚½ãƒ¼ã‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```terraform
resource "aws_s3_bucket_ownership_controls" "example" {
  bucket = aws_s3_bucket.example.id
  rule {
    object_ownership = "BucketOwnerEnforced"
  }
}
```

## aws_s3_bucket_objectãŒéæ¨å¥¨ã¸
AWS Provider v4.0ä»¥é™ã€aws_s3_bucket_objectãŒéæ¨å¥¨ã¨ãªã‚Šã¾ã—ãŸã®ã§ã€æ©Ÿèƒ½ãŒåŒã˜aws_s3_objectã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```terraform
resource "aws_s3_object" "example" {
  key    = "example.txt"  # aws_s3_objectã§ã¯"key"ã¯æœ‰åŠ¹
  bucket = aws_s3_bucket.this.id
}
```

## depends_onã§å€¤ã‚’ä¿è¨¼ã™ã‚‹
countã¾ãŸã¯for_eachã®æ¡ä»¶å¼ãŒã€planå®Ÿè¡Œæ™‚ã«ç¢ºå®šã§ããªã„å€¤ã«ä¾å­˜ã—ã¦ã„ã‚‹å ´åˆã€Error: Invalid count argument:ãŒç™ºç”Ÿã—ã¾ã™ã€‚   
depends_onã‚’ä½¿ç”¨ã—ã¦å€¤ã‚’ä¿è¨¼ã™ã‚‹ã¨è§£æ¶ˆã•ã‚Œã¾ã™ãŒã€ä½¿ã„ã™ãã‚‹ã¨è¤‡é›‘ãªä¾å­˜é–¢ä¿‚ã¨ãªã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

```terraform
depends_on = [aws_lambda_permission.allow_s3_to_invoke_lambda]
```

## S3é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ãŠã‘ã‚‹ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†

AWS S3ã®é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã¯ã€ç’°å¢ƒå¤‰æ•°ã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’S3ã§å…¬é–‹ã™ã‚‹å ´åˆã€ç’°å¢ƒå¤‰æ•°ã®å€¤ã¯ä»¥ä¸‹ã®æ–¹æ³•ã§è¨­å®šã§ãã¾ã™ï¼š

1. **ãƒ“ãƒ«ãƒ‰æ™‚åŸ‹ã‚è¾¼ã¿**: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ãƒ“ãƒ«ãƒ‰æ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€
2. **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å–å¾—**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«APIï¼ˆLambda/Edgeç­‰ï¼‰ã‹ã‚‰å‹•çš„ã«å–å¾—ã™ã‚‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„ç‚¹

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§æ©Ÿå¯†æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹ã“ã¨ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã—ç¾åœ¨ãã®ã‚ˆã†ãªè¨­è¨ˆã«ãªã£ã¦ã„ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ç‚¹ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ï¼š

- **å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚­ãƒ¼**: å…¬é–‹ã—ã¦ã‚‚å®‰å…¨ã‹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã‚„ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™ã‚’è¨­å®š
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹**: Supabaseã®anon keyãªã©ã€å…¬é–‹å‰æã®ã‚­ãƒ¼ã§ã‚‚RLSï¼ˆRow Level Securityï¼‰ç­‰ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿
- **èªè¨¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼ãªã©ã®æ©Ÿå¯†æƒ…å ±**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã¯å«ã‚ãªã„

### æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

AWSå…¬å¼ã§ã¯ã€S3å˜ä½“ã§ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚ˆã‚Šã‚‚Amplifyã§ã®çµ±åˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚   
Amplifyã‚‚S3ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸé™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ãŒã€Cloudflareã‚„Netlifyã€Vercelãªã©ã¨åŒæ§˜ã®ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ï¼š

- **Amplify Gen2**: çµ±åˆã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½
- **Amplify Gen1**: AWS Systems Manager Parameter Storeã¨ã®é€£æº

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šç®¡ç†ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸¡ç«‹ã§ãã¾ã™ã€‚
S3ã‹ã‚‰Parameter Storeã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã€CIç’°å¢ƒã‹ã‚‰S3ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãªã©ã®IAMç®¡ç†ã‚‚ç…©é›‘ã«ãªã‚Šã¾ã›ã‚“ã€‚

### S3ã§ã®SSR
S3ã¯é™çš„ãªãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ã«ç‰¹åŒ–ã—ã¦ã„ã‚‹ãŸã‚ã€Node.jsãªã©ã®ã‚µãƒ¼ãƒãƒ¼å®Ÿè¡Œç’°å¢ƒã‚’å¿…è¦ã¨ã™ã‚‹SSRã«ã¯ç›´æ¥å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

* **JAMStackã‚„BFFãªã©ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨æ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸæ§‹æˆã®SSR**:
    ã“ã®å ´åˆã¯ã€S3ã§é™çš„ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ›ã‚¹ãƒˆã—ã¤ã¤ã€SSRã®ãƒ­ã‚¸ãƒƒã‚¯ã¯åˆ¥ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆLambda@Edgeãªã©ï¼‰ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚
* **Next.jsã®App Routerãªã©ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè¡Œç’°å¢ƒã‚’å¿…è¦ã¨ã™ã‚‹æ©Ÿèƒ½**:
    ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å«ã‚€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’S3ã§é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã§æ©Ÿå¯†æƒ…å ±ã‚’æ‰±ã†å ´åˆã¯ã€Vercelã‚„Netlifyã®ã‚ˆã†ãªå°‚ç”¨ã®ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã€ã¾ãŸã¯AWS Amplifyã®ã‚ˆã†ãªçµ±åˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ç§»è¡Œã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Terraform Cloudã¨LocalStackã®æ¥ç¶šã‚¨ãƒ©ãƒ¼

**å•é¡Œ**: Terraform Cloudã®å®Ÿè¡Œç’°å¢ƒã‹ã‚‰`localhost:4566`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚`connection refused`ã‚¨ãƒ©ãƒ¼ãŒã§ã¾ã™ã€‚

**è§£æ±ºæ–¹æ³•**:
1. ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰cloudãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤/ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
2. `terraform init`ï¼ˆå‡ºæ¥ãªã„å ´åˆã¯`.terraform`å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œï¼‰
3. Terraform Cloudä¸Šã®å¤‰æ•°ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æ‰‹å‹•å…¥åŠ›

```bash
# cloudãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤å¾Œ
rm -rf .terraform
terraform init
export AWS_ACCESS_KEY_ID="test"
export AWS_SECRET_ACCESS_KEY="test"
```

## LocalStackã§ã®ã‚µãƒ¼ãƒ“ã‚¹åˆ¶é™ã«ã¤ã„ã¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯LocalStackã‚’åˆ©ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€LocalStackã®ç„¡æ–™ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ç‰ˆã§ã¯ä¸€éƒ¨ã®AWSã‚µãƒ¼ãƒ“ã‚¹ãŒæœªã‚µãƒãƒ¼ãƒˆã¾ãŸã¯æ©Ÿèƒ½ãŒé™å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`terraform apply`æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚¨ãƒ©ãƒ¼ä¾‹**:
```
Error: creating Amplify App: StatusCode: 501, api error InternalFailure: 
The API for service 'amplify' is either not included in your current license plan

Error: creating ECR Repository: operation error ECR: CreateRepository, https response error StatusCode: 501, RequestID: xxx, api error InternalFailure: The API for service 'ecr' is either not included in your current license plan or has not yet been emulated by LocalStack.

Error: creating ECS Cluster: operation error ECS: CreateCluster, https response error StatusCode: 501, RequestID: xxx, api error InternalFailure: The API for service 'ecs' is either not included in your current license plan or has not yet been emulated by LocalStack. 
```
