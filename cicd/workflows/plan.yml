name: Terraform Plan (Hybrid)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'bootstrap/**'
      - '.github/workflows/terraform-*.yml'

env:
  TF_VERSION: "1.5.0"
  TG_VERSION: "0.86.2"
  AWS_REGION: "ap-northeast-1"

permissions:
  id-token: write
  contents: read
  pull-requests: write # planã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  bootstrap-status:
    uses: ./.github/workflows/check-bootstrap.yml
    secrets:
      AWS_ROLE_ARN_DEV: ${{ secrets.AWS_ROLE_ARN_DEV }}
      AWS_ROLE_ARN_PROD: ${{ secrets.AWS_ROLE_ARN_PROD }}
      AWS_ROLE_ARN_LOCAL: ${{ secrets.AWS_ROLE_ARN_LOCAL }}

  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: bootstrap-status
    if: needs.bootstrap-status.outputs.bootstrap_ready == 'true'
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
      segments: ${{ steps.detect.outputs.segments }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      tg_environments: ${{ steps.detect.outputs.tg_environments }}
      tg_segments: ${{ steps.detect.outputs.tg_segments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: detect
        uses: ./.github/actions/detect-terraform-changes
        with:
          workflow_type: 'plan'
          aws_role_arn_local: ${{ secrets.AWS_ROLE_ARN_LOCAL }}

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [bootstrap-status, detect-changes] # bootstrap-status, detect-changesã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹
    if: needs.bootstrap-status.outputs.bootstrap_ready == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    # planå®Ÿè¡Œæ™‚é–“ã®çŸ­ç¸®ãŸã‚strategy matrixã‚’è¨­å®šã—dev, prodã‚’ä¸¦åˆ—ã§å®Ÿè¡Œã™ã‚‹
    strategy:
      matrix:
        environment: fromJson(needs.detect-changes.outputs.environments)
      fail-fast: false # ã©ã¡ã‚‰ã‹ã®ç’°å¢ƒãŒå¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: ./.github/actions/get-role-aws
        with:
          environment: ${{ matrix.environment }}

      - name: Setup IaC Tools
        uses: ./.github/actions/setup-iac-tools
        with:
          tf_version: ${{ env.TF_VERSION }}
          tg_version: ${{ env.TG_VERSION }}

      - name: Terraform Plan (Standard)
        id: plan-standard
        run: |
          echo "Running plan for environment: ${{ matrix.environment }}"
          make ${{ matrix.environment }}-plan
        continue-on-error: true

      - name: Format Plan Output # outcomeã§planã®å®Ÿè¡Œçµæœã‚’æ¤œè¨¼
        if: always()
        id: format
        run: |
          # ãƒ—ãƒ©ãƒ³çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          if [ "${{ steps.plan-standard.outcome }}" = "success" ]; then
            echo "PLAN_STATUS=âœ… Success" >> $GITHUB_ENV
          else
            echo "PLAN_STATUS=âŒ Failed" >> $GITHUB_ENV
          fi

      - name: Comment PR (Standard)
        if: always()
        uses: ./.github/actions/comment-pr
        with:
          title: 'ğŸ“‹ Terraform Plan Results (Standard)'
          body: | 
            **Environment**: `${{ matrix.environment }}`
            **Configuration**: `terraform/environments/${{ matrix.environment }}/`
            **Command**: `make ${{ matrix.environment }}-plan`
            
            <details>
            <summary>ğŸ“ Configuration Details</summary>
            
            - **Path**: `terraform/environments/${{ matrix.environment }}/`
            - **Command**: `make ${{ matrix.environment }}-plan`
            - **Provider**: Standard Terraform
            
            </details>
          outcome: ${{ steps.plan-standard.outcome }}

  segment-plan:
    name: Segment Plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [bootstrap-status, detect-changes]
    if: needs.bootstrap-status.outputs.bootstrap_ready == 'true' && needs.detect-changes.outputs.has_changes == 'true' && needs.detect-changes.outputs.segments != '[]'
    strategy:
      matrix:
        segment: ${{ fromJson(needs.detect-changes.outputs.segments) }}
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}
      fail-fast: false
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: ./.github/actions/get-role-aws
        with:
          environment: ${{ matrix.environment }}

      - name: Setup IaC Tools
        uses: ./.github/actions/setup-iac-tools
        with:
          tf_version: ${{ env.TF_VERSION }}
          tg_version: ${{ env.TG_VERSION }}

      - name: Segment Plan
        id: plan-segment
        run: |
          echo "Running segment plan for: ${{ matrix.segment }}-${{ matrix.environment }}"
          make seg-${{ matrix.segment }}-${{ matrix.environment }}-plan
        continue-on-error: true

      - name: Comment PR (Segment)
        if: always()
        uses: ./.github/actions/comment-pr
        with:
          title: 'ğŸ“‹ Segment Details'
          body: | 
            **Segment**: `${{ matrix.segment }}`
            **Environment**: `${{ matrix.environment }}`
            **Status**: ${{ steps.plan-segment.outcome }}
            **Configuration**: `terraform/segments/${{ matrix.segment }}/environments/${{ matrix.environment }}/`

            ${{ steps.plan-segment.outcome == 'success' ? 'âœ… Segment plan completed successfully.' : 'âŒ Segment plan failed. Please check the logs.' }}

            <details>
            <summary>ğŸ“ Segment Details</summary>

            - **Path**: `terraform/segments/${{ matrix.segment }}/environments/${{ matrix.environment }}/`
            - **Command**: `make seg-${{ matrix.segment }}-${{ matrix.environment }}-plan`
            - **Type**: Segment-based configuration

            </details>
          outcome: ${{ steps.plan-standard.outcome }}

  terragrunt-plan:
    name: Terragrunt Plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [bootstrap-status, detect-changes]
    if: needs.bootstrap-status.outputs.bootstrap_ready == 'true' && needs.detect-changes.outputs.tg_environments != '[]'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.tg_environments) }}
        segment: ${{ fromJson(needs.detect-changes.outputs.tg_segments) }}
    environment:
      name: ${{ matrix.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: ./.github/actions/get-role-aws
        with:
          environment: ${{ matrix.environment }}

      - name: Setup IaC Tools
        uses: ./.github/actions/setup-iac-tools
        with:
          tf_version: ${{ env.TF_VERSION }}
          tg_version: ${{ env.TG_VERSION }}

      - name: Terragrunt Plan
        id: plan-terragrunt
        run: |
          echo "Running Terragrunt plan for: ${{ matrix.segment }}-${{ matrix.environment }}"
          make tg-${{ matrix.segment }}-${{ matrix.environment }}-plan
        continue-on-error: true

      - name: Comment PR (Terragrunt)
        if: always()
        uses: ./.github/actions/comment-pr
        with:
          title: 'ğŸ“‹ Terragrunt Plan Results'
          body: | 
            **Segment**: `${{ matrix.segment }}`
            **Environment**: `${{ matrix.environment }}`
            **Status**: ${{ steps.plan-terragrunt.outcome }}
            **Configuration**: `terraform/live/${{ matrix.environment }}/${{ matrix.segment }}/`

            ${{ steps.plan-terragrunt.outcome == 'success' ?
              'âœ… Terragrunt plan completed successfully.' :
              'âŒ Terragrunt plan failed. Please check the logs.'
            }}
          outcome: ${{ steps.plan-standard.outcome }}

  bootstrap-required: # Secretsï¼ˆOIDCèªè¨¼ã«å¿…è¦ãªIAMãƒ­ãƒ¼ãƒ«ã®ARNï¼‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã«å®Ÿè¡Œ
    name: Bootstrap Setup Required
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: bootstrap-status
    if: needs.bootstrap-status.outputs.bootstrap_ready == 'false'
    steps:
      - name: Bootstrap Instructions
        run: |
          # OIDCèªè¨¼ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãŒæœªè¨­å®šã§ã‚ã‚‹ã“ã¨ã‚’è­¦å‘Š
          echo "## âš ï¸ Bootstrap Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OIDC authentication infrastructure needs to be configured." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # å­˜åœ¨ã—ãªã„GitHub Secretsã®åå‰ã‚’å‡ºåŠ›
          echo "### Missing GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.bootstrap-status.outputs.missing_secrets }}" | tr ' ' '\n' | while read secret; do
            if [ -n "$secret" ]; then
              echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ› ï¸ Setup Options:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 1: Manual Setup (Recommended)" >> $GITHUB_STEP_SUMMARY
          # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§terraform applyã‚’å®Ÿè¡Œã—ã€å‡ºåŠ›ã•ã‚ŒãŸARNã‚’GitHub Secretsã«æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹æ–¹æ³•
          echo "1. Run bootstrap locally with AWS CLI credentials" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'cd bootstrap' >> $GITHUB_STEP_SUMMARY
          echo 'terraform init' >> $GITHUB_STEP_SUMMARY
          echo 'terraform apply' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "2. Copy Role ARNs from output to GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 2: Workflow Setup (If AWS Access Keys Available)" >> $GITHUB_STEP_SUMMARY
          # ä¸€æ™‚çš„ãªAWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’Secretsã«è¿½åŠ ã—ã€å°‚ç”¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã•ã›ã‚‹ä»£æ›¿æ–¹æ³•
          echo "1. Add temporary \`AWS_ACCESS_KEY_ID\` and \`AWS_SECRET_ACCESS_KEY\` to secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Run 'Bootstrap OIDC Setup' workflow manually" >> $GITHUB_STEP_SUMMARY
          echo "3. Remove temporary credentials after OIDC setup completes" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç›´æ¥ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
        uses: actions/github-script@v7
        with:
          script: |
            const missingSecrets = '${{ needs.bootstrap-status.outputs.missing_secrets }}';
            // æ¸¡ã•ã‚ŒãŸmissing_secretsã‚’ç©ºç™½ã§åŒºåˆ‡ã‚Šç©ºæ–‡å­—ã‚’é™¤å¤–ã—Markdownã®ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹
            const secretsList = missingSecrets.split(' ')
              .filter(s => s.length > 0)
              .map(s => `- \`${s}\``)
              .join('\n');
            
            const body = `## âš ï¸ Bootstrap Setup Required
            
            The OIDC authentication infrastructure needs to be configured before Terraform can run.
            
            ### Missing GitHub Secrets:
            ${secretsList}
            
            ### ğŸ› ï¸ Quick Setup:
            
            1. **Run bootstrap locally:**
               \`\`\`bash
               cd bootstrap
               terraform init
               terraform apply
               \`\`\`
            
            2. **Add Role ARNs to GitHub Secrets:**
               - Go to [Repository Settings > Secrets](https://github.com/${{ github.repository }}/settings/secrets/actions)
               - Add the Role ARNs from terraform output
            
            3. **Re-run this workflow**
            
            ### ğŸ’¡ Alternative:
            Use the [Bootstrap OIDC Setup workflow](../../actions) if you have temporary AWS credentials available.
            
            ---
            *This is a one-time setup per repository.*`;
            
            // GitHub APIã‚’å‘¼ã³å‡ºã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [bootstrap-status, detect-changes, terraform-plan, segment-plan, terragrunt-plan] # å…¨ã¦ã®ã‚¸ãƒ§ãƒ–ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿ
    if: always() && (needs.terraform-plan.result != 'skipped' || needs.segment-plan.result != 'skipped' || needs.bootstrap-status.outputs.bootstrap_ready == 'false') # ãƒ—ãƒ©ãƒ³ãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ã€ã¾ãŸã¯ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãŒå¿…è¦ãªå ´åˆã«å®Ÿè¡Œ
    steps:
      - name: Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            // å„å…ˆè¡Œã‚¸ãƒ§ãƒ–ã®å‡ºåŠ›ã¨çµæœã‚’å–å¾—
            const bootstrapReady = '${{ needs.bootstrap-status.outputs.bootstrap_ready }}' === 'true';
            const standardResult = '${{ needs.terraform-plan.result }}';
            const segmentResult = '${{ needs.segment-plan.result }}';
            const terragruntResult = '${{ needs.terragrunt-plan.result }}';
            
            // å®‰å…¨ãªJSONè§£æ
            let environments = [];
            let segments = [];
            
            try {
              const envOutput = '${{ needs.detect-changes.outputs.environments || "[]" }}';
              environments = typeof envOutput === 'string' ? JSON.parse(envOutput) : envOutput;
            } catch (e) {
              console.log('Failed to parse environments output:', e);
              environments = [];
            }
            
            try {
              const segOutput = '${{ needs.detect-changes.outputs.segments || "[]" }}';
              segments = typeof segOutput === 'string' ? JSON.parse(segOutput) : segOutput;
            } catch (e) {
              console.log('Failed to parse segments output:', e);
              segments = [];
            }
            
            let summary = `## ğŸ“Š Terraform Plan Summary\n\n`;
            
            if (!bootstrapReady) {
              // bootstrap_readyãŒfalseã ã£ãŸå ´åˆ
              summary += `**Bootstrap Status**: âŒ Setup Required\n`;
              summary += `**Action Required**: Configure OIDC authentication\n\n`;
              summary += `See the bootstrap instructions comment above.\n`;
            } else {
              summary += `**Bootstrap Status**: âœ… Ready\n`;
              // å¤‰æ›´ã•ã‚ŒãŸç’°å¢ƒã¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€ãŠã‚ˆã³å„ãƒ—ãƒ©ãƒ³ã®çµæœï¼ˆæˆåŠŸã¾ãŸã¯å¤±æ•—ï¼‰ã‚’ç°¡æ½”ã«è¡¨ç¤º
              summary += `**Changed Environments**: ${environments.length > 0 ? environments.map(e => `\`${e}\``).join(', ') : 'None'}\n`;
              summary += `**Changed Segments**: ${segments.length > 0 ? segments.map(s => `\`${s}\``).join(', ') : 'None'}\n\n`;
              
              if (standardResult !== 'skipped') {
                summary += `**Standard Configuration**: ${standardResult === 'success' ? 'âœ…' : 'âŒ'} ${standardResult}\n`;
              }
              
              if (segmentResult !== 'skipped') {
                summary += `**Segment Configuration**: ${segmentResult === 'success' ? 'âœ…' : 'âŒ'} ${segmentResult}\n`;
              }

              if (terragruntResult !== 'skipped') {
                summary += `**Terragrunt Configuration**: ${terragruntResult === 'success' ? 'âœ…' : 'âŒ'} ${terragruntResult}\n`;
              }
              
              // ãƒ—ãƒ©ãƒ³çµæœã«åŸºã¥ã„ã¦ã€æ¬¡ã«å–ã‚‹ã¹ãè¡Œå‹•ã‚’å‡ºåŠ›
              if ([standardResult, segmentResult, terragruntResult].includes('success')) {
                summary += `\n### ğŸ” Next Steps\n`;
                summary += `- âœ… Review the plan details above\n`;
                summary += `- âœ… Merge this PR to apply changes\n`;
              } else if ([standardResult, segmentResult, terragruntResult].includes('failure')) {
                summary += `\n### ğŸ” Next Steps\n`;
                summary += `- âŒ Fix any plan errors before merging\n`;
                summary += `- ğŸ” Check workflow logs for detailed error information\n`;
              }
            }
            
            summary += `\n---\n*Generated by GitHub Actions â€¢ [View Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})*`;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®æ–°è¦ä½œæˆã¨æ›´æ–°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æ—¢å­˜ã®ã‚µãƒãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæ¤œç´¢
            const existingComment = comments.find(c =>
              c.body.includes("## ğŸ“Š Terraform Plan Summary")
            );
            
            // ã‚µãƒãƒªãƒ¼æ–°è¦ä½œæˆã¨æ›´æ–°ã®åˆ†å²
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }