name: Terraform Plan (Basic)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'bootstrap/**'
      - '.github/workflows/terraform-*.yml'

env:
  TF_VERSION: "1.5.0"
  AWS_REGION: "ap-northeast-1"

permissions:
  id-token: write
  contents: read
  pull-requests: write

# ç’°å¢ƒã¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’git diffã‹ã‚‰å–å¾—ã—å¤‰æ•°ã«æ ¼ç´ã™ã‚‹
jobs:
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
      segments: ${{ steps.detect.outputs.segments }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: detect
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾— ...ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ã§æ—¢å­˜ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã¾ã§ã‚’æ¯”è¼ƒã™ã‚‹
          # grepã§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã™ã‚‹ç‚ºã€^()ãªã©ã‚’-Eã§æ‹¡å¼µæ­£è¦è¡¨ç¾ã«ã—ã¦ã„ã‚‹ || trueã§terraformé–¢é€£ä»¥å¤–ã®å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
          changed_files=$(git diff --name-only origin/main...HEAD | grep -E '^(terraform|bootstrap)/' || true)
          
          # $changed_filesã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã§ã€ç©ºã ã£ãŸå ´åˆã®å‡ºåŠ›è¨­å®šã€è¦ã¯terraformé–¢é€£ã˜ã‚ƒãªã„å ´åˆã¯has_changesã«falseã‚’å…¥ã‚Œã‚‹
          if [ -z "$changed_files" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "environments=[]" >> $GITHUB_OUTPUT
            echo "segments=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # $changed_filesãŒç©ºã˜ã‚ƒãªã„å ´åˆã€has_changesã«trueã‚’å…¥ã‚Œã¦å‡ºåŠ›ã™ã‚‹
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changed files:"
          echo "$changed_files"
          
          # ç’°å¢ƒã‚’æ¤œå‡º
          # grepã§-o ( --only-matching ã®çŸ­ç¸®å½¢) ã‚’ä½¿ç”¨ã—ã¦ç’°å¢ƒæ–‡å­—ã ã‘å–å¾—ï¼ˆä¾‹ï¼šenvironments/devï¼‰
          # cutã§-dã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’/ã«æŒ‡å®šã—ã€-f2ã¨ã—ã¦2ç•ªç›®ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ–‡å­—åˆ—ã‚’å–å¾—ï¼ˆä¾‹ï¼šdevï¼‰
          # sortã—ã¦-uï¼ˆuniqueï¼‰ã§é‡è¤‡ã‚’å‰Šé™¤
          # jq -R -s -c 'split("\n")[:-1]'ã§1è¡Œã®JSONé…åˆ—ã«å¤‰æ›ã€€
          # -R (raw input)ã€€jqã«ä¸ãˆã‚‰ã‚ŒãŸå…¥åŠ›ã‚’ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã®ã§ã¯ãªãã€å˜ãªã‚‹æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿è¾¼ã¾ã›ã¾ã™
          # -s (slurp)ã€€-Rã§èª­ã¿è¾¼ã‚“ã è¤‡æ•°ã®æ–‡å­—åˆ—ã‚’ã€1ã¤ã®é…åˆ—ã«ã¾ã¨ã‚ã¦ã‹ã‚‰jqãƒ•ã‚£ãƒ«ã‚¿ã«æ¸¡ã—ã¾ã™
          # ä¾‹ãˆã°ã€å…¥åŠ›ãŒdev\nprod\nã®å ´åˆã€-Rã ã‘ã§ã¯"dev"ã¨"prod"ãŒåˆ¥ã€…ã«å‡¦ç†ã•ã‚Œã¾ã™ãŒã€-Rsã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€"dev\nprod\n"ã¨ä¸€ã¤ã®æ–‡å­—åˆ—ã«ãªã‚‹
          # -c (compact output) jqã®å‡ºåŠ›ã‚’æ”¹è¡Œãªã—ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãª1è¡Œã«ã—ã¾ã™
          # æ”¹è¡Œã‚’splitã§åŒºåˆ‡ã‚Šã€æœ«å°¾æ”¹è¡Œã«ã‚ˆã‚‹ç©ºæ–‡å­—åˆ—ã‚’[:-1]ã§æœ«å°¾ã‹ã‚‰ä¸€ã¤å‰ã¨æŒ‡å®šã—ã¦é…åˆ—ã‹ã‚‰é™¤å¤–ã™ã‚‹ï¼ˆä¾‹ï¼š["dev", "prod", ""] => ["dev", "prod"]ï¼‰
          
          environments=$(echo "$changed_files" | grep -oE 'environments/(local|dev|prod)' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]' || echo '[]')
          echo "environments=$environments" >> $GITHUB_OUTPUT
          
          # ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ¤œå‡º
          segments=$(echo "$changed_files" | grep -oE 'segments/(foundation|application|data_processing)' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]' || echo '[]')
          echo "segments=$segments" >> $GITHUB_OUTPUT
          
          echo "Detected environments: $environments"
          echo "Detected segments: $segments"

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', matrix.environment)] || secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Bootstrap Check
        id: bootstrap-check
        run: |
          echo "Checking if bootstrap is required for ${{ matrix.environment }}..."
          if [ ! -f "bootstrap/.terraform.lock.hcl" ] || [ ! -d "bootstrap/.terraform" ]; then
            echo "needs_bootstrap=true" >> $GITHUB_OUTPUT
          else
            echo "needs_bootstrap=false" >> $GITHUB_OUTPUT
          fi

      - name: Bootstrap Plan
        if: steps.bootstrap-check.outputs.needs_bootstrap == 'true'
        working-directory: ./bootstrap
        run: |
          terraform init
          terraform plan -var="environment=${{ matrix.environment }}"

      - name: Terraform Plan (Standard)
        id: plan-standard
        run: |
          echo "Running plan for environment: ${{ matrix.environment }}"
          make ${{ matrix.environment }}-plan
        continue-on-error: true

      - name: Format Plan Output
        if: always()
        id: format
        run: |
          # ãƒ—ãƒ©ãƒ³çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          if [ "${{ steps.plan-standard.outcome }}" = "success" ]; then
            echo "PLAN_STATUS=âœ… Success" >> $GITHUB_ENV
          else
            echo "PLAN_STATUS=âŒ Failed" >> $GITHUB_ENV
          fi

      - name: Comment PR (Standard)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ matrix.environment }}';
            const status = process.env.PLAN_STATUS;
            const outcome = '${{ steps.plan-standard.outcome }}';
            
            const body = `
            ## ğŸ“‹ Terraform Plan Results (Standard)
            
            **Environment**: \`${environment}\`
            **Status**: ${status}
            **Configuration**: \`terraform/environments/${environment}/\`
            
            ${outcome === 'success' ? 
              'âœ… Plan completed successfully. Review the changes before merging.' : 
              'âŒ Plan failed. Please check the logs and fix any issues.'
            }
            
            <details>
            <summary>ğŸ“ Configuration Details</summary>
            
            - **Path**: \`terraform/environments/${environment}/\`
            - **Command**: \`make ${environment}-plan\`
            - **Provider**: Standard Terraform
            
            </details>
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes(`## ğŸ“‹ Terraform Plan Results (Standard)`) &&
              comment.body.includes(`**Environment**: \`${environment}\``)
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  segment-plan:
    name: Segment Plan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && needs.detect-changes.outputs.segments != '[]'
    strategy:
      matrix:
        segment: ${{ fromJson(needs.detect-changes.outputs.segments) }}
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', matrix.environment)] || secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Segment Plan
        id: plan-segment
        run: |
          echo "Running segment plan for: ${{ matrix.segment }}-${{ matrix.environment }}"
          make seg-${{ matrix.segment }}-${{ matrix.environment }}-plan
        continue-on-error: true

      - name: Comment PR (Segment)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const segment = '${{ matrix.segment }}';
            const environment = '${{ matrix.environment }}';
            const outcome = '${{ steps.plan-segment.outcome }}';
            const status = outcome === 'success' ? 'âœ… Success' : 'âŒ Failed';
            
            const body = `
            ## ğŸ§© Segment Plan Results
            
            **Segment**: \`${segment}\`
            **Environment**: \`${environment}\`
            **Status**: ${status}
            **Configuration**: \`terraform/segments/${segment}/environments/${environment}/\`
            
            ${outcome === 'success' ? 
              'âœ… Segment plan completed successfully.' : 
              'âŒ Segment plan failed. Please check the logs.'
            }
            
            <details>
            <summary>ğŸ“ Segment Details</summary>
            
            - **Path**: \`terraform/segments/${segment}/environments/${environment}/\`
            - **Command**: \`make seg-${segment}-${environment}-plan\`
            - **Type**: Segment-based configuration
            
            </details>
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes(`## ğŸ§© Segment Plan Results`) &&
              comment.body.includes(`**Segment**: \`${segment}\``) &&
              comment.body.includes(`**Environment**: \`${environment}\``)
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan, segment-plan]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const standardResult = '${{ needs.terraform-plan.result }}';
            const segmentResult = '${{ needs.segment-plan.result }}';
            
            let summary = `## ğŸ“Š Terraform Plan Summary\n\n`;
            
            if (standardResult !== 'skipped') {
              summary += `**Standard Configuration**: ${standardResult === 'success' ? 'âœ…' : 'âŒ'} ${standardResult}\n`;
            }
            
            if (segmentResult !== 'skipped') {
              summary += `**Segment Configuration**: ${segmentResult === 'success' ? 'âœ…' : 'âŒ'} ${segmentResult}\n`;
            }
            
            summary += `\n### ğŸ” Next Steps\n`;
            
            if (standardResult === 'success' || segmentResult === 'success') {
              summary += `- âœ… Review the plan details above\n`;
              summary += `- âœ… Merge this PR to apply changes\n`;
            } else {
              summary += `- âŒ Fix any plan errors before merging\n`;
            }
            
            summary += `\n---\n*Generated by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });